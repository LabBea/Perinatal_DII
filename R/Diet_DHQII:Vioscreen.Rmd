---
title: "Maternal Diet - DHQII and Vioscreen"
output:
  html_notebook:
    fig_caption: yes
Author: Suzanne Alvernaz
---


This script is used to analyze the maternal diet based on two food frequency questionnaires, DHQII & Vioscreen. For each of these questionnaires, this script will calculate the population demographics, Dietary Inflammatory Index (DII) and HEI score. For data, see the Bealab box folder

# Notebook Set-up {.tabset}
***
## Notebook parameters
```{r Set-up}
knitr::opts_chunk$set(echo = TRUE,
                      fig.height = 3,
                      fig.width = 7,
                      fig.path = 'figures',
                      fig.align = "center",
                      fig.cap = TRUE)
```

## Required Packages  
IMPORTANT: "here" package is for writing new folders/files into this projects working directory. All path files are relative this folder and not absolute so the project folder can be transferred and run anywhere with no editing
```{r library}
library(tidyverse)
library(here) 
library(lubridate)
library(arsenal)
library(captioner)
library(ggpubr)
library(survival)
library(corrplot)
library(ICC)
library(ggbiplot)
#library(conflicted)
```

## Table & Figure captions  
All captions were made using the package [captioner](https://cran.r-project.org/web/packages/captioner/vignettes/using_captioner.html), and stored in one chunk to allow more accessible editing
```{r fig-table-cap}
table_nums <- captioner(prefix = "Table")
fig_nums <- captioner(prefix = "Figure")
#Tables ###############################################################
#Table caption for DHQII demographic/DII data
table_nums("DHQII_DII_Demo_Table", 
           "Characteristics of DHQII participants based on energy corrected DII tertile. P-values for continuous variables calculated via Linear-Model ANOVA and for categorical variables by  Pearson's Chi-squared test")

#Table caption for DHQII Nutritional Data
table_nums("DHQII_nutr", "Nutrient composition of DHQII participants diet. Discrete values were corrected for total energy intake. P-values for continuous variables calculated via Linear Model ANOVA")

#Table caption for DHQII DII HEI table
table_nums("DHQII_DII_Demo_HEI_Table", "Characteristics of DHQII participants based on energy corrected DII tertile, includes HEI2015 score. P-values for continuous variables calculated via Linear-Model ANOVA and for categorical variables by  Pearson's Chi-squared test")

#Table caption for vioscreen demographic/DII data
table_nums("Vioscreen_DII_Demo_Table",
           "Characteristics of Vioscreen participants based on energy corrected DII tertile. P-values for continuous variables calculated via Linear-Model ANOVA and for categorical variables by  Pearson's Chi-squared test")

#Table caption for DII between pre and postpartum vioscreen surveys
table_nums("Vioscreen_DII_pre_post",
           "Changes in DII score between pre-partum and post-partum. Score calculated from Vioscreen")

#Table Caption for pre-partum vioscreen Nutritional Data
table_nums("Vio_nutr", "Nutrient composition of pre-partum Vioscreen participants diet. Discrete values were corrected for total energy intake. P-values for continuous variables calculated via Linear Model ANOVA")

#Table Caption for pre-partum vioscreen Nutritional Data
table_nums("Vio_nutr_post", "Nutrient composition of post-partum Vioscreen participants diet. Discrete values were corrected for total energy intake. P-values for continuous variables calculated via Linear Model ANOVA")


#Table caption for Vioscreen DII HEI table
table_nums("Vioscreen_DII_Demo_HEI_Table", "Characteristics of Vioscreen participants based on energy corrected DII tertile, includes HEI2015 score. P-values for continuous variables calculated via Linear-Model ANOVA and for categorical variables by  Pearson's Chi-squared test")

#Table caption for Vioscreen HEI changes across pregnancy
table_nums("vHEI_pre_post",
           "Changes in HEI score between pre-partum and post-partum. Score calculated from Vioscreen")

#Table caption for Combined Demo, DII, and HEI from Vioscreen and DHQII
table_nums("Combined_DII_Demo_HEI_Table", "Combined demographics from Vioscreen and DHQII participants based on energy corrected DII tertile, includes HEI2015 score. P-values for continuous variables calculated via Linear-Model ANOVA and for categorical variables by  Pearson's Chi-squared test")

#Figures ##############################################################
fig_nums("DII&HEI", "HEI2015 score as a function of energy corrected DII. Both metrics determined from DHQII, P-values calculated from Pearson Correlation")

#Figure captions for Vioscreen data
fig_nums("vDII&HEI", "Energy corrected DII as a function of HEI2015 score. Both metrics determined from Vioscreen. P-values determined from Pearson Correlation")
fig_nums("HEI&DIIchange", "Change in maternal DII pre and post-partum as a function of the change in HEI2015 score. P-values determined from Pearson Correlation")

```


# DHQII Analysis {.tabset}
***
The Diet History Questionnaire II (DHQII) for the US and Canada is a validated food frequency questionnaire that measures 134 food items and 8 supplementary measures. Information about this metric and its validation can be found through the  [NIH](https://epi.grants.cancer.gov/dhq2/)  
  
## Dietary Inflammatory Index (DII)  from DHQII  
**DII Background**  
DII is a metric of inflammation based on food parameters. The original paper uses 45 metrics. Here, we use 27 variables to calculate DII. Positivie scores are associated with increased pro-inflammatory cytokines and negatively associated with anti-inflammatory cytokines. In our calculation, we adjusted for energy intake by using each participants total calorie intake. For more information, see the 
[reference article](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3925198/).  

  __Energy Intake Correction__     
DII was adjusted for participant energy intake by dividing each parameter by that participants total kcal and multiplying by 1000. Additionally, those who reported total KCAL energy intake less than 500 or more than 5000 were removed fromt this dataset. 
```{r DHQII-DII, warning=False}
#STEP 1: DHQII DATA######################################################################
#Assign DHQII data to object
DHQII <- read.csv(here::here("Data", "Diet_Data", "DHQII_RAW.csv"))

#Convert the date
DHQII$Questionnaire.Date <- ymd(DHQII$Questionnaire.Date)

#Create table dplyr::filtered to only include DII Variables: Note the missing variables listed below
DHQII_f <- DHQII %>% 
  select(Respondent_ID, ALCOHOL_G_USDA, VITAMIN_B12_MCG_USDA, VITAMIN_B6_MG_USDA, BETA_CAROTENE_MCG_USDA, CAFFEINE_MG_USDA, CARBOHYDRATE_G_USDA, CHOLESTEROL_MG_USDA, ENERGY_KCAL_USDA, TOTAL_FAT_G_USDA, TOTAL_DIETARY_FIBER_G_NDSR, FOLIC_ACID_MCG_USDA, IRON_MG_USDA, MAGNESIUM_MG_USDA, MUFA_14_1_MYRISTOLEIC_ACID_G_NDSR, NIACIN_MG_USDA, TOTAL_PROTEIN_G_NDSR, TOTAL_POLYUNSAT_FA_G_USDA, RIBOFLAVIN_VITAMIN_B2_MG_USDA, TOTAL_SAT_FA_G_USDA, SELENIUM_MCG_USDA, THIAMIN_VITAMIN_B1_MG_USDA, TOTAL_TRANS_FATTY_ACIDS_TRANS_G_NDSR, VITAMIN_A_RAE_MCG_USDA, VITAMIN_C_MG_USDA, VITAMIN_D_CALCIFEROL_MCG_NDSR, VITAMIN_E_AS_ALPHA_TOCOPHEROL_MG_USDA, ZINC_MG_USDA)

#Convert Caffeine milligrams to grams
DHQII_f$CAFFEINE_MG_USDA <- DHQII_f$CAFFEINE_MG_USDA/1000


#Convert Respondent ID to Row names
rownames(DHQII_f) <- DHQII_f[,1]
DHQII_f[,1] <- NULL

#Remove those who's daily energy intake is <500 or >5000 KCAL
DHQII_fb <- dplyr::filter(DHQII_f, !(ENERGY_KCAL_USDA > 5000 | ENERGY_KCAL_USDA < 500))

#Correct by KCal intake to get the energy adjusted variable
#see methods in https://www.frontiersin.org/articles/10.3389/fnut.2021.604296/full for reasoning
#Formula is nutrient/Kcal intake * 1000
#DHQII_f1 <- DHQII_fb[,]/DHQII_fb$ENERGY_KCAL_USDA*1000
#DHQII_f1$ENERGY_KCAL_USDA <- DHQII_fb$ENERGY_KCAL_USDA

#dplyr::rename DHQII_f columns to match row names in DIIr
DHQII_f2 <- dplyr::rename(DHQII_fb, "Alcohol (g)" = ALCOHOL_G_USDA, 	
                   "Vitamin B12 (μg)" = VITAMIN_B12_MCG_USDA,
                   "Vitamin B6 (mg)" = VITAMIN_B6_MG_USDA,
                   "β-Carotene (μg)" = BETA_CAROTENE_MCG_USDA,
                   "Caffeine (g)" = CAFFEINE_MG_USDA,
                   "Carbohydrate (g)" = CARBOHYDRATE_G_USDA,
                   "Cholesterol (mg)" = CHOLESTEROL_MG_USDA,
                   "Energy (kcal)" = ENERGY_KCAL_USDA,
                   "Total fat (g)" = TOTAL_FAT_G_USDA,
                   "Fibre (g)" = TOTAL_DIETARY_FIBER_G_NDSR,
                   "Folic acid (μg)" = FOLIC_ACID_MCG_USDA,
                   "Fe (mg)" = IRON_MG_USDA,
                   "Mg (mg)" = MAGNESIUM_MG_USDA,
                   "MUFA (g)" = MUFA_14_1_MYRISTOLEIC_ACID_G_NDSR,
                   "Niacin (mg)" = NIACIN_MG_USDA,
                   "Protein (g)" = TOTAL_PROTEIN_G_NDSR,
                   "PUFA (g)" = TOTAL_POLYUNSAT_FA_G_USDA,
                   "Riboflavin (mg)" = RIBOFLAVIN_VITAMIN_B2_MG_USDA,
                   "Saturated fat (g)" = TOTAL_SAT_FA_G_USDA,
                   "Se (μg)" = SELENIUM_MCG_USDA,
                   "Thiamin (mg)" = THIAMIN_VITAMIN_B1_MG_USDA,
                   "Trans fat (g)" = TOTAL_TRANS_FATTY_ACIDS_TRANS_G_NDSR,
                   "Vitamin A (RE)" = VITAMIN_A_RAE_MCG_USDA,
                   "Vitamin C (mg)" = VITAMIN_C_MG_USDA,
                   "Vitamin D (μg)" = VITAMIN_D_CALCIFEROL_MCG_NDSR,
                   "Vitamin E (mg)" = VITAMIN_E_AS_ALPHA_TOCOPHEROL_MG_USDA,
                   "Zn (mg)" = ZINC_MG_USDA)


#STEP 2: DII DATA########################################################################
#import DII Reference table to an object
##https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3925198/ 
###Note: Correct the decimal points and negative signs manually before importing
DIIr <- read.csv(here::here("Data", "Diet_Data", "DII_Reference_Table.csv"),
                 stringsAsFactors=FALSE)
DIIr2 <- dplyr::rename(DIIr, "Mean" = Global.daily.mean.intake...units.d.)  

##remove blank rows, convert food parameters to row names and remove that column
DIIr3 <- DIIr2[-c(46,47), ]      
rownames(DIIr3) <- DIIr3[,1]
DIIr3[,1] <- NULL

#convert the dashes into smaller - so it can be converted into a negative - in the column
DIIr3[,2] <- gsub("–", "-", DIIr3[,2])


##Transpose the dataframe. Converts it to a matrix so return to dataframe
DIIr4 <- t(DIIr3)
DIIr5 <- data.frame(DIIr4, stringsAsFactors=FALSE)

#Remove Variables from DII reference table that are missing from DHQII data
DIIr6 <- select(DIIr5, -c("Eugenol..mg.", "Garlic..g.", "Ginger..g.", "n.3.Fatty.acids..g.", 
                          "n.6.Fatty.acids..g.", "Onion..g.", "Saffron..g.", "Turmeric..mg.",
                          "Flavan.3.ol..mg.", "Green.black.tea..g.", "Flavones..mg.", 
                          "Flavonols..mg.", "Flavonones..mg.", "Anthocyanidins..mg.", 
                          "Isoflavones..mg.", "Pepper..g.", "Thyme.oregano..mg.", "Rosemary..mg."))
DIIr6b <- DIIr6[-c(6), ]

#convert to numeric
DIIr7 <- as.data.frame(apply(DIIr6b, c(1,2), as.numeric)) 
DIIr12 <- DIIr7

##convert names back, got messed up when we transposed the dataframe
DIIr13 <- dplyr::rename(DIIr12, "Alcohol (g)" = Alcohol..g., 	
                   "Vitamin B12 (μg)" = Vitamin.B12..μg.,
                   "Vitamin B6 (mg)" = Vitamin.B6..mg.,
                   "β-Carotene (μg)" = β.Carotene..μg.,
                   "Caffeine (g)" = Caffeine..g.,
                   "Carbohydrate (g)" = Carbohydrate..g.,
                   "Cholesterol (mg)" = Cholesterol..mg.,
                   "Energy (kcal)" = Energy..kcal.,
                   "Total fat (g)" = Total.fat..g.,
                   "Fibre (g)" = Fibre..g.,
                   "Folic acid (μg)" = Folic.acid..μg.,
                   "Fe (mg)" = Fe..mg.,
                   "Mg (mg)" = Mg..mg.,
                   "MUFA (g)" = MUFA..g.,
                   "Niacin (mg)" = Niacin..mg.,
                   "Protein (g)" = Protein..g.,
                   "PUFA (g)" = PUFA..g.,
                   "Riboflavin (mg)" = Riboflavin..mg.,
                   "Saturated fat (g)" = Saturated.fat..g.,
                   "Se (μg)" = Se..μg.,
                   "Thiamin (mg)" = Thiamin..mg.,
                   "Trans fat (g)" = Trans.fat..g.,
                   "Vitamin A (RE)" = Vitamin.A..RE.,
                   "Vitamin C (mg)" = Vitamin.C..mg.,
                   "Vitamin D (μg)" = Vitamin.D..μg.,
                   "Vitamin E (mg)" = Vitamin.E..mg.,
                   "Zn (mg)" = Zn..mg.)

#STEP 3: Calculation########################################################################

##Subtract the mean (Row #4 in reference dataframe)
#####################################################
sub.mean <- function(x){
            x-DIIr13[4, 1:27]
}

DIIm1 <-  apply(DHQII_f2, 1, sub.mean)
DIIm2 <- bind_rows(DIIm1, .id = "column_label")
rownames(DIIm2) <- DIIm2[,1]
DIIm2[,1] <- NULL


##Dived by SD (Row #5 in reference dataframe)
#####################################################
div.SD <- function(x){
            x/DIIr13[5, 1:27]
  }

DIIsd1 <-  apply(DIIm2, 1, div.SD)
DIIsd2 <- bind_rows(DIIsd1, .id = "column_label")
rownames(DIIsd2) <- DIIsd2[,1]
DIIsd2[,1] <- NULL

#Convert to percentile -> using pnorm() by person
#####################################################
DIIp <- data.frame(t(DIIsd2))
DIIp2 <- data.frame(t(apply(DIIp, 2, pnorm)))

#double each value and subtract 1
#####################################################
doub.per <- function(x){
            x*2 - 1
}

DIIp3 <-  apply(DIIp2, 2, doub.per)
DIIp4 <- data.frame(DIIp3)

#Multiple by overall effect score (Row #3in reference data-frame) to get "food parameter-specific DII score"
#####################################################
mult.ov <- function(x){
            x*DIIr13[3, 1:27]
}

DIIov <-  apply(DIIp4, 1, mult.ov)
DIIov2 <- bind_rows(DIIov, .id = "column_label")
rownames(DIIov2) <- DIIov2[,1]
DIIov2[,1] <- NULL


#Sum all scores to get DII
#####################################################
DIIov2$DII <- rowSums(DIIov2)

#create dataframe with ID and DII score only
#####################################################
DIIov3 <- DIIov2 %>%
  rownames_to_column('dhqid')

DII1 <- data.frame(row.names = DIIov3$dhqid,
                  DIIov3$DII)
DII1 <- dplyr::rename(DII1, "DII" = DIIov3.DII)



#Step 4: Match to redcapid########################################################
#use csv with redcapid and respondent id
DIIredcapid <- read.csv(here::here("Data", "Diet_Data",
                        "PMHCRRMicrobiomeStar-REDCapIDDHQIIID_DATA_2021-09-20_1259.csv"))
DIIredcapid2 <- DIIredcapid %>%
  unite("dhqid", dhq_id1:dhq_id2:dhq_id3:dhq_id4:dhq_id5, sep = "")
DIIredcapid2 <- DIIredcapid2[-which(DIIredcapid2$dhqid == ""), ]
#remove duplicate dhqid. I removed the second one?
DIIredcapid3 <- DIIredcapid2[-c(12), ]
DIIredcapid4 <- DIIredcapid3 %>% 
  remove_rownames %>% column_to_rownames(var="dhqid")

#Correct DII dataframe
##dplyr::filter the DII that has a redcapid
DII2 <- DII1 %>%
  rownames_to_column('dhqid')

#merge dataframes and dplyr::filter so we only have DII with redcapids
DII3 <- merge(DII2, DIIredcapid3) %>% dplyr::filter(!is.na(redcapid))
DII5 <- DII3 %>% select(DII, redcapid)
DII5$redcapid<-gsub("B","",as.character(DII5$redcapid)) #Remove B from redcapid


#Calculate tertiles of DII
DII6 <- DII5 %>%
  dplyr::mutate(tertiles = ntile(DII, 3)) %>%
  dplyr::mutate(tertiles = if_else(tertiles == 1, 'Tertile 1', if_else(tertiles == 2, 'Tertile 2', 'Tertile 3')))
#  arrange("DII")

``` 


__Test DII Computation with dietaryindex package__  

"Alcohol (g)" = Alcohol..g., 	
                   "Vitamin B12 (μg)" = Vitamin.B12..μg.,
                   "Vitamin B6 (mg)" = Vitamin.B6..mg.,
                   "β-Carotene (μg)" = β.Carotene..μg.,
                   "Caffeine (g)" = Caffeine..g.,
                   "Carbohydrate (g)" = Carbohydrate..g.,
                   "Cholesterol (mg)" = Cholesterol..mg.,
                   "Energy (kcal)" = Energy..kcal.,
                   "Total fat (g)" = Total.fat..g.,
                   "Fibre (g)" = Fibre..g.,
                   "Folic acid (μg)" = Folic.acid..μg.,
                   "Fe (mg)" = Fe..mg.,
                   "Mg (mg)" = Mg..mg.,
                   "MUFA (g)" = MUFA..g.,
                   "Niacin (mg)" = Niacin..mg.,
                   "Protein (g)" = Protein..g.,
                   "PUFA (g)" = PUFA..g.,
                   "Riboflavin (mg)" = Riboflavin..mg.,
                   "Saturated fat (g)" = Saturated.fat..g.,
                   "Se (μg)" = Se..μg.,
                   "Thiamin (mg)" = Thiamin..mg.,
                   "Trans fat (g)" = Trans.fat..g.,
                   "Vitamin A (RE)" = Vitamin.A..RE.,
                   "Vitamin C (mg)" = Vitamin.C..mg.,
                   "Vitamin D (μg)" = Vitamin.D..μg.,
                   "Vitamin E (mg)" = Vitamin.E..mg.,
                   "Zn (mg)" = Zn..mg.



```{r}
#DHQII_test <- rownames_to_column(DHQII_f2, "Subjects")

#DHQII_DII_packcalc <- DII(SERV_DATA = DHQII_test, RESPONDENTID = "Subjects",
 #                         ALCOHOL_DII = "Alcohol (g)",
  #                        VITB12_DII = "Vitamin B12 (μg)",
   #                       VITB6_DII  = "Vitamin B6 (mg)",
    #               BCAROTENE_DII = "β-Carotene (μg)",
     #              CAFFEINE_DII =  "Caffeine (g)",
      #             CARB_DII =  "Carbohydrate (g)",
       #            CHOLES_DII =  "Cholesterol (mg)",
        #           KCAL_DII =  "Energy (kcal)",
         #          TOTALFAT_DII =  "Total fat (g)",
          #         FIBER_DII =  "Fibre (g)",
           #        FOLICACID_DII =  "Folic acid (μg)",
            #       IRON_DII = "Fe (mg)",
             #      MG_DII =  "Mg (mg)",
              #     MUFA_DII =  "MUFA (g)",
               #    NIACIN_DII =  "Niacin (mg)",
                #   PROTEIN_DII =  "Protein (g)",
                 #  PUFA_DII =  "PUFA (g)",
                  # RIBOFLAVIN_DII = "Riboflavin (mg)",
                   #SATFAT_DII =  "Saturated fat (g)",
      #             SE_DII = "Se (μg)",
       #            THIAMIN_DII =  "Thiamin (mg)",
        #           TRANSFAT_DII =  "Trans fat (g)",
         #          VITA_DII =  "Vitamin A (RE)",
          #         VITC_DII =  "Vitamin C (mg)",
           #        VITD_DII =  "Vitamin D (μg)",
            #       VITE_DII =  "Vitamin E (mg)",
             #      ZN_DII =  "Zn (mg)")
```




Used for later - take initial DII variables data.frame and convert to redcap names. This is used in the final chunk to merge together all DII variables from Vioscreen and DHQII. Needed for Microbiome analysis
```{r}
DHQQ_DII_data <- merge(DHQII_f2, DIIredcapid4, by=0, all=TRUE) %>% dplyr::filter(!is.na(redcapid))
DHQQ_DII_data$redcapid <- gsub("B","",as.character(DHQQ_DII_data$redcapid))
DHQQ_DII_data <- DHQQ_DII_data %>% column_to_rownames("redcapid")
DHQQ_DII_data <- DHQQ_DII_data[,-c(1,29)]
#Drop the NA
DHQQ_DII_data <- na.omit(DHQQ_DII_data)

```



## Demographics of DHQII participants {.tabset}

### Table of Demographics &  DII 
```{r DHQII-Demographics&DII-table, results="asis", message=FALSE, warning=FALSE}
#import RedCap Data
RedcapD <- read.csv(here::here("Data", "Diet_Data", "REDCapData_02102021.csv"))

#dplyr::filter these moms for the ones who also have DII diet data
RedcapDf <- RedcapD %>%
  dplyr::filter(redcapid %in% DIIredcapid4$redcapid)


#dplyr::filter the variables I want in my table into a new obj
##gestational weeks? - 2nd trimester when DHQII questionnaire administered?
RCDemoD <- RedcapDf %>%
  select(redcapid, pi_age, demo_ethnic___1, demo_ethnic___2, demo_racial___1, demo_racial___2, demo_racial___2, demo_racial___3, demo_racial___4, demo_racial___5, demo_racial___6, demo_relationshipstatus, demo_relationshipstatus, demo_healthcarecosts___1, demo_healthcarecosts___2, demo_healthcarecosts___3, demo_healthcarecosts___4, demo_education, demo_work, demo_income)

#Remove rows with NA for age becuase they should have answered demographic/age questions in the same visit
RCDemof <- RCDemoD %>%
  group_by(redcapid) %>%
   dplyr::filter(!is.na(pi_age))

#Change numerical answers to descriptions
###for race: combine American Indian/Alaska, Asian, and Hawaiian into Other
###for healthcare: medicare and medicaid = public
###for education: Below College, up to college, above college for higher than BA/BS
###for employment: Unemployed = unemployed/homemaker, Employed part/full time = full time, part time, occasional
###for marital status: Single = Single, Seperated/Widowed = divorced, widowed. Married/Relationship = Married, committed relationship
RCDemof2 <- RCDemof %>%
  dplyr::mutate(demo_ethnic___1 = case_when(
                     demo_ethnic___1 == 1 ~ "Hispanic/Latino")) %>%
  dplyr::mutate(demo_ethnic___2 = case_when(
                     demo_ethnic___2 == 1 ~ "Non-Hispanic/Latino")) %>%
  dplyr::mutate(demo_racial___1 = case_when(
                     demo_racial___1 == 1 ~ "Other")) %>%
  dplyr::mutate(demo_racial___2 = case_when(
                     demo_racial___2 == 1 ~ "Other")) %>%
  dplyr::mutate(demo_racial___3 = case_when(
                     demo_racial___3 == 1 ~ "Other")) %>%
  dplyr::mutate(demo_racial___4 = case_when(
                     demo_racial___4 == 1 ~ "Black")) %>%
  dplyr::mutate(demo_racial___5 = case_when(
                     demo_racial___5 == 1 ~ "White")) %>%
  dplyr::mutate(demo_racial___6 = case_when(
                     demo_racial___6 == 1 ~ "Other")) %>%
  dplyr::mutate(demo_relationshipstatus = case_when(
                      demo_relationshipstatus == 1 ~ "Single",
                      demo_relationshipstatus == 2 ~ "Married/Relationship",
                      demo_relationshipstatus == 3 ~ "Married/Relationship",
                      demo_relationshipstatus == 4 ~ "Seperated/Widowed",
                      demo_relationshipstatus == 5 ~ "Seperated/Widowed",
                      demo_relationshipstatus == 6 ~ "Seperated/Widowed")) %>%
  dplyr::mutate(demo_healthcarecosts___1 = case_when(
                     demo_healthcarecosts___1 == 1 ~ "Private")) %>%
  dplyr::mutate(demo_healthcarecosts___2 = case_when(
                     demo_healthcarecosts___2 == 1 ~ "Federal Aide")) %>%
  dplyr::mutate(demo_healthcarecosts___3 = case_when(
                     demo_healthcarecosts___3 == 1 ~ "Federal Aide")) %>%
  dplyr::mutate(demo_healthcarecosts___4 = case_when(
                     demo_healthcarecosts___4 == 1 ~ "Private")) %>%
  dplyr::mutate(demo_income = case_when(
                     demo_income == 1 ~ "<$31k",
                     demo_income == 2 ~ "<$31k",
                     demo_income == 3 ~ "<$31k",
                     demo_income == 4 ~ "$31-76k",
                     demo_income == 5 ~ "$31-76k",
                     demo_income == 6 ~ "$76k+",
                     demo_income == 7 ~ "$76k+",
                     demo_income == 8 ~ "$76k+")) %>%
  dplyr::mutate(demo_education = case_when(
                     demo_education == 1 ~ "Below College",
                     demo_education == 2 ~ "Below College",
                     demo_education == 3 ~ "College",
                     demo_education == 4 ~ "College",
                     demo_education == 5 ~ "College",
                     demo_education == 6 ~ "Above College",
                     demo_education == 7 ~ "Above College",
                     demo_education == 8 ~ "Above College")) %>%
  dplyr::mutate(demo_work = case_when(
                     demo_work == 1 ~ "Unemployed",
                     demo_work == 2 ~ "Unemployed",
                     demo_work == 3 ~ "Employed Part/Full Time",
                     demo_work == 4 ~ "Employed Part/Full Time",
                     demo_work == 5 ~ "Employed Part/Full Time"))


#Unite Columns and dplyr::rename for the table
 RCDemof3 <- RCDemof2 %>%
  dplyr::rename(Age = pi_age) %>%
  unite("Ethnicity", demo_ethnic___1:demo_ethnic___2, na.rm = TRUE, remove = TRUE) %>%
  unite("Race",demo_racial___1:demo_racial___2:demo_racial___3:demo_racial___4:demo_racial___5:demo_racial___6, 
         na.rm = TRUE, remove = TRUE) %>%
  dplyr::rename("Relationship Status" = demo_relationshipstatus) %>%
  unite("Health Insurance", 
        demo_healthcarecosts___1:demo_healthcarecosts___2:demo_healthcarecosts___3:demo_healthcarecosts___4, 
        na.rm = TRUE, remove = TRUE) %>%
  dplyr::rename(Income = demo_income) %>%
  dplyr::rename(Education = demo_education) %>%
  dplyr::rename (Employment = demo_work) 

 #remove B from some of the redcapids
RCDemof3$redcapid<-gsub("B","",as.character(RCDemof3$redcapid))
 
#change redcapid to row names
RCDemof4 <- RCDemof3 %>% remove_rownames %>% column_to_rownames(var="redcapid")

#replace blanks with "Unreported"
RCDemof4[RCDemof4 == ""] <- "Unreported"

# Import BMI and planned pregnancy dataframes##############################################
#BMI
RedcapBMI <- read.csv(here::here("Data", "Diet_Data", "PMHCRRMicrobiomeStar-BMI_DATA_2021-09-20_1256.csv"))

RedcapBMI2 <- RedcapBMI %>%
  group_by(redcapid) %>%
   dplyr::filter(!is.na(mr_v1_bmi_initialob))
RedcapBMI2 <- RedcapBMI2 %>% dplyr::rename (BMI = mr_v1_bmi_initialob)
RedcapBMI2$redcap_event_name <- NULL

RedcapBMI_DHQII <- RedcapBMI2 %>% 
  dplyr::filter(redcapid %in% DII5$redcapid)


#Planned Pregnancy 
RedcapPP <- read.csv(here::here("Data", "Diet_Data", "CCTSCRDWRequestUICCI-MedicalRecordsV1Othe_DATA_2021-09-20_1255.csv"))
RedcapPP2 <- RedcapPP %>% select(record_id, mr_v1_pregnancyinfo_planned_pregnancy)
RedcapPP2 <- RedcapPP2 %>% dplyr::mutate(mr_v1_pregnancyinfo_planned_pregnancy = case_when(
  mr_v1_pregnancyinfo_planned_pregnancy == 1 ~ "Yes", 
  mr_v1_pregnancyinfo_planned_pregnancy == 0 ~ "No"))
RedcapPP2[is.na(RedcapPP2)] <- "Unreported"
RedcapPP3 <- RedcapPP2 %>% dplyr::rename(redcapid = record_id) %>% dplyr::rename("Planned Pregnancy" = mr_v1_pregnancyinfo_planned_pregnancy)

RedcapPP_DHQII <- RedcapPP3 %>% 
  dplyr::filter(redcapid %in% DII5$redcapid)

#now ready to proceed to making the table
#Step 1: Combine the Two Datasets into one##################################################
#dplyr::filter Demographics dataframe to only have redcapids for DII5 (final DII table)
RCDemof5 <- RCDemof3 %>%
  dplyr::filter(redcapid %in% DII5$redcapid)

#Merge dataframes
Demo_DIIa <- merge(RCDemof5, DII6)
Demo_DIIb <- merge(Demo_DIIa, RedcapBMI_DHQII)
Demo_DII <- merge(Demo_DIIb, RedcapPP_DHQII)

#Step 2: Table results######################################################################
#change redcapid to row names
Demo_DII2 <- Demo_DII %>% remove_rownames %>% column_to_rownames(var="redcapid")
#Reorder the columns
Demo_DII3 <- Demo_DII2[, c(9, 1, 2, 3, 4, 5, 6, 7, 8, 10, 11, 12)]

#Make datafrmae with redcapid and DHQII date (for later use) ################################
DHQII_Dates <- data.frame(DHQII$Respondent_ID, DHQII$Questionnaire.Date)
DHQII_Dates2 <- DHQII_Dates %>% 
  dplyr::rename(dhqid = DHQII.Respondent_ID) %>%
  dplyr::rename(Survey_Date = DHQII.Questionnaire.Date)

DHQII_Dates3 <- merge(DHQII_Dates2, DIIredcapid3) %>% dplyr::filter(!is.na(redcapid))
DHQII_Dates4 <- DHQII_Dates3[,-c(1,4)]

##Note: pfootnote=TRUE will return which statistical test was used for the tableby function
DDDtable <- tableby(tertiles  ~ ., data = Demo_DII3)
summary(DDDtable, title = "DII Tertile") 

```
`r table_nums("DHQII_DII_Demo_Table", display = "full")`


## Basic Nutrient Table for DHQII participants
This table will give a snapshot of the diet breakdown by race among DHQII participants
```{r DHQII-Nutrient-Table, results="asis"}
#Step 1: Select desired nutrient from DHQII raw data (use variable from above)####################

#create dataframe with variables
NutrTD <- DHQII %>% 
  select(Respondent_ID, ENERGY_KCAL_USDA, X..Energy.from.CARBOHYDRATE_G_USDA, X..Energy.from.PROTEIN_G_USDA, 
         X..Energy.from.TOTAL_FAT_G_USDA, X..Energy.from.TOTAL_SATURATED_FATTY_ACIDS_G_USDA, 
         X..Energy.from.TOTAL_MONOUNSATURATED_FATTY_ACIDS_G_USDA,
         X..Energy.from.TOTAL_POLYUNSATURATED_FATTY_ACIDS_G_USDA, X..Energy.from.ALCOHOL_G_USDA, DIETARY_FIBER_G_USDA,
         CHOLESTEROL_MG_USDA, VITAMIN_A_RAE_MCG_USDA,
         FOLIC_ACID_MCG_USDA, VITAMIN_C_MG_USDA, VITAMIN_D_CALCIFEROL_MCG_NDSR, VITAMIN_E_AS_ALPHA_TOCOPHEROL_MG_USDA,
         CALCIUM_MG_USDA, IRON_MG_USDA, POTASSIUM_MG_USDA, SODIUM_MG_USDA)

#Correct hard values by total energy intake
NutrTD1 <- NutrTD[, 10:20]/NutrTD$ENERGY_KCAL_USDA*1000
#replace the original dataframe values with these corrected values
NutrTD[,10:20] <- NutrTD1

#change respondent ID to redcapid
NutrTD2 <- NutrTD %>%
  dplyr::rename('dhqid' = Respondent_ID)


####dplyr::filter the DHQII that has a redcapid
NutrTD3 <- merge(DIIredcapid3, NutrTD2, all= TRUE) %>% dplyr::filter(!is.na(redcapid))
NutrTD3$redcapid<-gsub("B","",as.character(NutrTD3$redcapid))

####remove columns we dont want
NutrTD4 <- subset(NutrTD3, select= -c(dhqid, redcap_event_name))

#Step 2: Merge with Demographic data###################################
#dplyr::filter Demographics dataframe to only have redcapids for DHQII nutrient dataframe
RCDemof6 <- RCDemof3 %>%
  dplyr::filter(redcapid %in% NutrTD4$redcapid)

#Merge dataframes
Demo_NutrTD <- merge(RCDemof6, NutrTD4)
Demo_NutrTD2 <- Demo_NutrTD %>% remove_rownames %>% column_to_rownames(var="redcapid")

#remove the unwanted demo columns
names(Demo_NutrTD2) <- str_replace_all(names(Demo_NutrTD2),  c(" " = "."))

Demo_NutrTD3 <- subset(Demo_NutrTD2, select= -c(Age, Ethnicity, Relationship.Status, 
                                                Health.Insurance, Education, Employment, Income))

#dplyr::rename the variables
Demo_NutrTD4 <- dplyr::rename(Demo_NutrTD3, 
                  "Energy (kcal)" = ENERGY_KCAL_USDA,
                  "% Carbohydrates" = X..Energy.from.CARBOHYDRATE_G_USDA,
                  "% Protein" = X..Energy.from.PROTEIN_G_USDA,
                  "% Total Fat" = X..Energy.from.TOTAL_FAT_G_USDA, 
                  "% Saturated Fat" = X..Energy.from.TOTAL_SATURATED_FATTY_ACIDS_G_USDA,
                  "% Monounsaturated Fats" = X..Energy.from.TOTAL_MONOUNSATURATED_FATTY_ACIDS_G_USDA,
                  "% Polyunsaturated Fats" = X..Energy.from.TOTAL_POLYUNSATURATED_FATTY_ACIDS_G_USDA,
                  "% Alcohol" = X..Energy.from.ALCOHOL_G_USDA,
                  "Fiber (g)" = DIETARY_FIBER_G_USDA,
                  "Cholesterol (mg)" = CHOLESTEROL_MG_USDA,
                  "Vitamin A (RE)" = VITAMIN_A_RAE_MCG_USDA,
                  "Folic acid (μg)" = FOLIC_ACID_MCG_USDA,
                  "Vitamin C (mg)" = VITAMIN_C_MG_USDA,
                  "Vitamin D (μg)" = VITAMIN_D_CALCIFEROL_MCG_NDSR,
                  "Vitamin E (mg)" = VITAMIN_E_AS_ALPHA_TOCOPHEROL_MG_USDA,
                  "Calcium (mg)" = CALCIUM_MG_USDA,
                  "Iron (mg)" = IRON_MG_USDA,
                  "Potassium (mg)" = POTASSIUM_MG_USDA,
                  "Sodium (mg)" = SODIUM_MG_USDA)


#Step 3: Make the Table ###############################################
NutrientTableD <- tableby(Race ~ ., data = Demo_NutrTD4)
summary(NutrientTableD, title = "Race")
```
`r table_nums("DHQII_nutr", display = "full")` 

## Healthy Eating Index (HEI) from DHQII {.tabset}    
__HEI Background__  
The Healthy Eating Index (HEI) is a scoring system composed of thirteen metrics of food intake. Score range from 0-100, with higher scores reflecting a better diet. More information about HEI can be found on the [USDA website](https://www.fns.usda.gov/healthy-eating-index-hei)
  
__HEI Calculation__  
HEI can be calculated directly from DHQII using the sas code found [here](https://epi.grants.cancer.gov/dhq2/dietcalc/output.html). Note on running sas in Rmarkdown; this requires the use of the package SASmarkdown. However this requires sas to be downloaded on your computer and there is no sas application currently for mac. So this script was run in sas studio online and the HEI file is imported here. 

### HEI Data combined with Demographics/DII
```{r DHQII-HEI, results="asis"}
#import HEI csv calculated in sas
D_HEI <- read.csv(here::here("Data", "Diet_Data", "DHQII_HEI.csv"))

#dplyr::filter to only keep HEI rows we want
D_HEI2 <- D_HEI[, c(1, 221, 222, 223, 224, 225, 226, 
                   227, 228, 229, 230, 231, 232, 233, 234, 
                   235, 236, 237, 238, 239, 240, 241, 242, 
                   243, 244, 245, 246, 247)]

#dplyr::filter HEI to match redcapids
##dplyr::filter the DII that has a redcapid
D_HEI3 <- dplyr::rename(D_HEI2, "dhqid" = Respondent_ID)
D_HEI4 <- merge(DIIredcapid3, D_HEI3, all= TRUE) %>% dplyr::filter(!is.na(redcapid))
D_HEI4$redcapid<-gsub("B","",as.character(D_HEI4$redcapid))
D_HEI5 <- D_HEI4[, -c(1,3)]

#DF with just redcapid and total score
D_HEI6 <- D_HEI5[, c(1,2)]
D_HEI7 <- dplyr::rename(D_HEI6, "HEI2015Score" = Total.HEI.2015.Score)

#merge with DII & Demographics dataframe
Demo_DII_HEI <- merge(Demo_DII, D_HEI7)

#change redcapid to row names
Demo_DII_HEI2 <- Demo_DII_HEI %>% remove_rownames %>% column_to_rownames(var="redcapid")
#Re-order rows
Demo_DII_HEI3 <- Demo_DII_HEI2[, c(9,13,1,2,3,4,5,6,7,8,10,11,12)]

#Write a table
DDDHtable <- tableby(tertiles  ~ ., data = Demo_DII_HEI3)
summary(DDDHtable, title = "DII Tertile") 

```
`r table_nums("DHQII_DII_Demo_HEI_Table", display = "full")`


# Vioscreen Analysis {.tabset}
***  
Vioscreen is a food frequency questionnaire that proivdes 90 days of food tracking. Further information can be found on the vioscreen [website](https://www.viocare.com/vioscreen.html)

## Dietary Inflammatory Index (DII)  from Vioscreen  
For information on DII, see description under the DHQII DII calculation


```{r Vioscreen-DII}
#STEP 1: Vioscreen DATA######################################################################


#Assign Vioscreen data to object
Vio <- read.csv(here::here("Data", "Diet_Data", "Vioscreen_RAW.csv"))

#Create table dplyr::filtered to only include DII Variables: Use the same variables used for DHQII DII calc
##Used total alpha tocopherol (Vit E) instead of activity 
Vio_f <- Vio %>% 
  select(BCODEID, STARTED, FINISHED, alcohol, vitb12, vitb6, betacar, caffeine, carbo, cholest, calories, fat, fiber, 
         totfolat, iron, magnes, mfa141, niacin, protein, pfatot, ribofla, sfatot, selenium, thiamin,
         totaltfa, vita_rae, vitc, vitd, alphtoco, zinc)

#Remove test run rows
Vio_f1 <- Vio_f[-c(39:48), ]

#Make dataframe with dates for later use
Vioscreen_Dates <- data_frame(Vio_f1$BCODEID, Vio_f1$FINISHED)
Vioscreen_Dates1 <- Vioscreen_Dates %>%
  dplyr::rename("redcapid" = `Vio_f1$BCODEID`) %>%
  dplyr::rename("Survey_Date" = `Vio_f1$FINISHED`)

#convert Caffeine from milligrams to grams
Vio_f1$caffeine <- Vio_f1$caffeine/1000

#Move Pre/Post-partum Vioscreen data into a separate dataframe
Vio_pre_post <- Vio_f1[c(34, 35, 30, 31, 27,28, 25, 26, 24, 23),]

#dplyr::filter original df to only contain pre-partum data and remove dates
Vio_f2 <- Vio_f1[-c(35, 30, 27, 26, 23), -c(2,3)]

#Convert ID to Rownames
rownames(Vio_f2) <- Vio_f2[,1]
Vio_f2[,1] <- NULL

#Remove those who's daily energy intake is <500 or >5000 KCAL
Vio_f2b <- dplyr::filter(Vio_f2, !(calories > 5000 | calories < 500))


#Correct by KCal intake to get the energy adjusted variable
#Vio_f3 <- Vio_f2b[,]/Vio_f2b$calories*1000
#Vio_f3$calories <- Vio_f2b$calories

#dplyr::rename columns to match row names in DIIr
Vio_f4 <- dplyr::rename(Vio_f2b, "Alcohol (g)" = alcohol, 	
                   "Vitamin B12 (μg)" = vitb12,
                   "Vitamin B6 (mg)" = vitb6,
                   "β-Carotene (μg)" = betacar,
                   "Caffeine (g)" = caffeine,
                   "Carbohydrate (g)" = carbo,
                   "Cholesterol (mg)" = cholest,
                   "Energy (kcal)" = calories,
                   "Total fat (g)" = fat,
                   "Fibre (g)" = fiber,
                   "Folic acid (μg)" = totfolat,
                   "Fe (mg)" = iron,
                   "Mg (mg)" = magnes,
                   "MUFA (g)" = mfa141,
                   "Niacin (mg)" = niacin,
                   "Protein (g)" = protein,
                   "PUFA (g)" = pfatot,
                   "Riboflavin (mg)" = ribofla,
                   "Saturated fat (g)" = sfatot,
                   "Se (μg)" = selenium,
                   "Thiamin (mg)" = thiamin,
                   "Trans fat (g)" = totaltfa,
                   "Vitamin A (RE)" = vita_rae,
                   "Vitamin C (mg)" = vitc,
                   "Vitamin D (μg)" = vitd,
                   "Vitamin E (mg)" = alphtoco,
                   "Zn (mg)" = zinc)



#STEP 2: Calculation########################################################################
#Following the same steps as in the DHQII calc. Uses the same functions and reference df

##Subtract the mean (Row #4 in reference dataframe)
#####################################################
DIIvm1 <-  apply(Vio_f4, 1, sub.mean)
DIIvm2 <- bind_rows(DIIvm1, .id = "column_label")
rownames(DIIvm2) <- DIIvm2[,1]
DIIvm2[,1] <- NULL

##Dived by SD (Row #5 in reference dataframe)
#####################################################
DIIvsd1 <-  apply(DIIvm2, 1, div.SD)
DIIvsd2 <- bind_rows(DIIvsd1, .id = "column_label")
rownames(DIIvsd2) <- DIIvsd2[,1]
DIIvsd2[,1] <- NULL

#Convert to percentile - using pnorm()
#####################################################
DIIvp <- data.frame(t(DIIvsd2))
DIIvp2 <- data.frame(t(apply(DIIvp, 2, pnorm)))


#double each value and subtract 1
#####################################################
DIIvp3 <-  apply(DIIvp2, 2, doub.per)
DIIvp4 <- data.frame(DIIvp3)

#Multiple by overall effect score (Row #3in reference dataframe) to get "food parameter-specific DII score"
#####################################################
DIIvov <-  apply(DIIvp4, 1, mult.ov)
DIIvov2 <- bind_rows(DIIvov, .id = "column_label")
rownames(DIIvov2) <- DIIvov2[,1]
DIIvov2[,1] <- NULL

#Sum all scores to get DII
#####################################################
DIIvov2$DII <- rowSums(DIIvov2)

#create dataframe with ID and DII score only
#####################################################
DIIvov3 <- DIIvov2 %>%
  rownames_to_column('redcapid')

vDII1 <- data.frame(DIIvov3$redcapid, DIIvov3$DII)
vDII1 <- dplyr::rename(vDII1, "DII" = DIIvov3.DII,
                "redcapid" = DIIvov3.redcapid)

#Calculate tertiles of DII
#####################################################
vDII2 <- vDII1 %>%
  dplyr::mutate(tertiles = ntile(DII, 3)) %>%
  dplyr::mutate(tertiles = if_else(tertiles == 1, 'Tertile 1', if_else(tertiles == 2, 'Tertile 2', 'Tertile 3'))) %>%
  dplyr::arrange("DII")

#Final DII Dataframe
vDII2$redcapid <- gsub("X", "", vDII2$redcapid)

```



## Demographics of Vioscreen participants {.tabset}   

### Table of Demographics & DII  
Participants who marked their race as Black/Other or Black/white on the surveys are reported as Black in this analysis
```{r Vioscreen-Demographics, warning=False}
#dplyr::filter these moms for the ones who also have vioscreen DII diet data
vRedcapDf <- RedcapD %>%
  dplyr::filter(redcapid %in% vDII2$redcapid)

#dplyr::filter the variables I want in my table into a new obj
##gestaitonal weeks? - 2nd trimester when DHQII questionaire adminstered?
vRCDemoD <- vRedcapDf %>%
  select(redcapid,pi_age, demo_ethnic___1, demo_ethnic___2, demo_racial___1, demo_racial___2, demo_racial___2, demo_racial___3, demo_racial___4, demo_racial___5, demo_racial___6, demo_relationshipstatus, demo_relationshipstatus, demo_healthcarecosts___1, demo_healthcarecosts___2, demo_healthcarecosts___3, demo_healthcarecosts___4, demo_education, demo_work, demo_income)

#Remove rows with NA for age becuase they should have answered demographic/age questions in the same visit
vRCDemof <- vRCDemoD %>%
  group_by(redcapid) %>%
   dplyr::filter(!is.na(pi_age))

#Change numerical answers to descriptions
###for race: combine American Indian/Alaska, Asian, and Hawaiian into Other
###for healthcare: medicare and medicaid = public
###for education: Below College, up to college, above college for higher than BA/BS
###for employment: Unemployed = unemployed/homemaker, Employed part/full time = full time, part time, occasional
###for marital status: Single = Single, Seperated/Widowed = divorced, widowed. Married/Relationship = Married, committed relationship
vRCDemof2 <- vRCDemof %>%
  dplyr::mutate(demo_ethnic___1 = case_when(
                     demo_ethnic___1 == 1 ~ "Hispanic/Latino")) %>%
  dplyr::mutate(demo_ethnic___2 = case_when(
                     demo_ethnic___2 == 1 ~ "Non-Hispanic/Latino")) %>%
  dplyr::mutate(demo_racial___1 = case_when(
                     demo_racial___1 == 1 ~ "Other")) %>%
  dplyr::mutate(demo_racial___2 = case_when(
                     demo_racial___2 == 1 ~ "Other")) %>%
  dplyr::mutate(demo_racial___3 = case_when(
                     demo_racial___3 == 1 ~ "Other")) %>%
  dplyr::mutate(demo_racial___4 = case_when(
                     demo_racial___4 == 1 ~ "Black")) %>%
  dplyr::mutate(demo_racial___5 = case_when(
                     demo_racial___5 == 1 ~ "White")) %>%
  dplyr::mutate(demo_racial___6 = case_when(
                     demo_racial___6 == 1 ~ "Other")) %>%
  dplyr::mutate(demo_relationshipstatus = case_when(
                      demo_relationshipstatus == 1 ~ "Single",
                      demo_relationshipstatus == 2 ~ "Married/Relationship",
                      demo_relationshipstatus == 3 ~ "Married/Relationship",
                      demo_relationshipstatus == 4 ~ "Seperated/Widowed",
                      demo_relationshipstatus == 5 ~ "Seperated/Widowed",
                      demo_relationshipstatus == 6 ~ "Seperated/Widowed")) %>%
  dplyr::mutate(demo_healthcarecosts___1 = case_when(
                     demo_healthcarecosts___1 == 1 ~ "Private")) %>%
  dplyr::mutate(demo_healthcarecosts___2 = case_when(
                     demo_healthcarecosts___2 == 1 ~ "Federal Aide")) %>%
  dplyr::mutate(demo_healthcarecosts___3 = case_when(
                     demo_healthcarecosts___3 == 1 ~ "Federal Aide")) %>%
  dplyr::mutate(demo_healthcarecosts___4 = case_when(
                     demo_healthcarecosts___4 == 1 ~ "Private")) %>%
  dplyr::mutate(demo_income = case_when(
                     demo_income == 1 ~ "<$31k",
                     demo_income == 2 ~ "<$31k",
                     demo_income == 3 ~ "<$31k",
                     demo_income == 4 ~ "$31-76k",
                     demo_income == 5 ~ "$31-76k",
                     demo_income == 6 ~ "$76k+",
                     demo_income == 7 ~ "$76k+",
                     demo_income == 8 ~ "$76k+")) %>%
  dplyr::mutate(demo_education = case_when(
                     demo_education == 1 ~ "Below College",
                     demo_education == 2 ~ "Below College",
                     demo_education == 3 ~ "College",
                     demo_education == 4 ~ "College",
                     demo_education == 5 ~ "College",
                     demo_education == 6 ~ "Above College",
                     demo_education == 7 ~ "Above College",
                     demo_education == 8 ~ "Above College")) %>%
  dplyr::mutate(demo_work = case_when(
                     demo_work == 1 ~ "Unemployed",
                     demo_work == 2 ~ "Unemployed",
                     demo_work == 3 ~ "Employed Part/Full Time",
                     demo_work == 4 ~ "Employed Part/Full Time",
                     demo_work == 5 ~ "Employed Part/Full Time"))

#Unite Columns and dplyr::rename for the table
 vRCDemof3 <- vRCDemof2 %>%
  dplyr::rename(Age = pi_age) %>%
  unite("Ethnicity", demo_ethnic___1:demo_ethnic___2, na.rm = TRUE, remove = TRUE) %>%
  unite("Race",demo_racial___1:demo_racial___2:demo_racial___3:demo_racial___4:demo_racial___5:demo_racial___6, 
         na.rm = TRUE, remove = TRUE) %>%
  dplyr::rename("Relationship Status" = demo_relationshipstatus) %>%
  unite("Health Insurance", 
        demo_healthcarecosts___1:demo_healthcarecosts___2:demo_healthcarecosts___3:demo_healthcarecosts___4, 
        na.rm = TRUE, remove = TRUE) %>%
  dplyr::rename(Income = demo_income) %>%
  dplyr::rename(Education = demo_education) %>%
  dplyr::rename (Employment = demo_work)
 
#replace blanks with "Unreported"
vRCDemof3[vRCDemof3 == ""] <- "Unreported"

#dplyr::rename those who reported twice
vRCDemof3 <- vRCDemof3 %>% 
  dplyr::mutate(Race = ifelse(as.character(Race) == "Other_Black", "Black", as.character(Race)))
vRCDemof3 <- vRCDemof3 %>% 
  dplyr::mutate(Race = ifelse(as.character(Race) == "Black_White", "Black", as.character(Race)))

#now ready to proceed to making the table
#Step 1: Combine the Datasets into one (Demo, BMI, Planned Pregnancy)##################################################

#dplyr::filter Demographics dataframe to only have vioscreen redcapids
vRCDemof4 <- vRCDemof3 %>%
  dplyr::filter(redcapid %in% vDII2$redcapid) 

#dplyr::filter BMIs dataframe to only have vioscreen redcapids
RedcapBMI2_V <- RedcapBMI2 %>%
  dplyr::filter(redcapid %in% vDII2$redcapid) 

#dplyr::filter Planned Pregnancy dataframe to only have vioscreen redcapids
RedcapPP3_V <- RedcapPP3 %>%
  dplyr::filter(redcapid %in% vDII2$redcapid) 


#Merge dataframes
vDemo_DIIa <- merge(vRCDemof4, vDII2)
vDemo_DIIb <- merge(vDemo_DIIa, RedcapBMI2_V)
vDemo_DII <- merge(vDemo_DIIb, RedcapPP3_V)

#Step 2: Table results######################################################################
#change redcapid to row names
vDemo_DII2 <- vDemo_DII %>% remove_rownames %>% column_to_rownames(var="redcapid")
#Reorder the columns
vDemo_DII3 <- vDemo_DII2[, c(11, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 12)]
##Note: pfootnote=TRUE will return which statistical test was used for the tableby function
vDDDtable <- tableby(tertiles  ~ ., data = vDemo_DII3)
summary(vDDDtable, title = "DII Tertile") 
```
`r table_nums("Vioscreen_DII_Demo_Table", display = "full")` 

    

## DII Changes Across Pregnancy
```{r Pre-Post-Partum-DII}

#Seperate out Pre and Post Partum nutrient tables
Vio_pre <- Vio_pre_post[c(1,4,6,8,9), -c(2,3)]

Vio_post <- Vio_pre_post[c(2,3,5,7,10), -c(2,3)]

#Convert ID to Rownames
rownames(Vio_pre) <- Vio_pre[,1]
Vio_pre[,1] <- NULL

rownames(Vio_post) <- Vio_post[,1]
Vio_post[,1] <- NULL

#dplyr::rename columns to match row names in DIIr
Vio_pre3 <- dplyr::rename(Vio_pre, "Alcohol (g)" = alcohol,   
                   "Vitamin B12 (μg)" = vitb12,
                   "Vitamin B6 (mg)" = vitb6,
                   "β-Carotene (μg)" = betacar,
                   "Caffeine (g)" = caffeine,
                   "Carbohydrate (g)" = carbo,
                   "Cholesterol (mg)" = cholest,
                   "Energy (kcal)" = calories,
                   "Total fat (g)" = fat,
                   "Fibre (g)" = fiber,
                   "Folic acid (μg)" = totfolat,
                   "Fe (mg)" = iron,
                   "Mg (mg)" = magnes,
                   "MUFA (g)" = mfa141,
                   "Niacin (mg)" = niacin,
                   "Protein (g)" = protein,
                   "PUFA (g)" = pfatot,
                   "Riboflavin (mg)" = ribofla,
                   "Saturated fat (g)" = sfatot,
                   "Se (μg)" = selenium,
                   "Thiamin (mg)" = thiamin,
                   "Trans fat (g)" = totaltfa,
                   "Vitamin A (RE)" = vita_rae,
                   "Vitamin C (mg)" = vitc,
                   "Vitamin D (μg)" = vitd,
                   "Vitamin E (mg)" = alphtoco,
                   "Zn (mg)" = zinc)


Vio_post3 <- dplyr::rename(Vio_post, "Alcohol (g)" = alcohol,   
                   "Vitamin B12 (μg)" = vitb12,
                   "Vitamin B6 (mg)" = vitb6,
                   "β-Carotene (μg)" = betacar,
                   "Caffeine (g)" = caffeine,
                   "Carbohydrate (g)" = carbo,
                   "Cholesterol (mg)" = cholest,
                   "Energy (kcal)" = calories,
                   "Total fat (g)" = fat,
                   "Fibre (g)" = fiber,
                   "Folic acid (μg)" = totfolat,
                   "Fe (mg)" = iron,
                   "Mg (mg)" = magnes,
                   "MUFA (g)" = mfa141,
                   "Niacin (mg)" = niacin,
                   "Protein (g)" = protein,
                   "PUFA (g)" = pfatot,
                   "Riboflavin (mg)" = ribofla,
                   "Saturated fat (g)" = sfatot,
                   "Se (μg)" = selenium,
                   "Thiamin (mg)" = thiamin,
                   "Trans fat (g)" = totaltfa,
                   "Vitamin A (RE)" = vita_rae,
                   "Vitamin C (mg)" = vitc,
                   "Vitamin D (μg)" = vitd,
                   "Vitamin E (mg)" = alphtoco,
                   "Zn (mg)" = zinc)

#STEP 2: Calculation########################################################################
#Following the same steps as in the DHQII calc. Uses the same functions and reference df

##Subtract the mean (Row #4 in reference dataframe)
DIIpre.m1 <-  apply(Vio_pre3, 1, sub.mean)
DIIpre.m2 <- bind_rows(DIIpre.m1, .id = "column_label")
rownames(DIIpre.m2) <- DIIpre.m2[,1]
DIIpre.m2[,1] <- NULL

DIIpost.m1 <-  apply(Vio_post3, 1, sub.mean)
DIIpost.m2 <- bind_rows(DIIpost.m1, .id = "column_label")
rownames(DIIpost.m2) <- DIIpost.m2[,1]
DIIpost.m2[,1] <- NULL


##Dived by SD (Row #5 in reference dataframe)
DIIpre.sd1 <- apply(DIIpre.m2, 1, div.SD)
DIIpre.sd2 <- bind_rows(DIIpre.sd1, .id = "column_label")
rownames(DIIpre.sd2) <- DIIpre.sd2[,1]
DIIpre.sd2[,1] <- NULL

DIIpost.sd1 <- apply(DIIpost.m2, 1, div.SD)
DIIpost.sd2 <- bind_rows(DIIpost.sd1, .id = "column_label")
rownames(DIIpost.sd2) <- DIIpost.sd2[,1]
DIIpost.sd2[,1] <- NULL


#Convert to percentile ########################################

#Pre
DIIpre.p <- as.data.frame(t(DIIpre.sd2))
DIIpre.p2 <- data.frame(t(apply(DIIpre.p, 2, pnorm)))


#Post
DIIpost.p <- as.data.frame(t(DIIpost.sd2))
DIIpost.p2 <- data.frame(t(apply(DIIpost.p, 2, pnorm)))


#double each value and subtract 1
DIIpre.p3 <- apply(DIIpre.p2, 2, doub.per)
DIIpre.p4 <- data.frame(DIIpre.p3)

DIIpost.p3 <- apply(DIIpost.p2, 2, doub.per)
DIIpost.p4 <- data.frame(DIIpost.p3)


#Multiple by overall effect score (Row #3in reference dataframe) to get "food parameter-specific DII score"
DIIpre.ov <-  apply(DIIpre.p4, 1, mult.ov)
DIIpre.ov2 <- bind_rows(DIIpre.ov, .id = "column_label")
rownames(DIIpre.ov2) <- DIIpre.ov2[,1]
DIIpre.ov2[,1] <- NULL

DIIpost.ov <-  apply(DIIpost.p4, 1, mult.ov)
DIIpost.ov2 <- bind_rows(DIIpost.ov, .id = "column_label")
rownames(DIIpost.ov2) <- DIIpost.ov2[,1]
DIIpost.ov2[,1] <- NULL


#Sum all scores to get DII
DIIpre.ov2$DII <- rowSums(DIIpre.ov2)

DIIpost.ov2$DII <- rowSums(DIIpost.ov2)

#create dataframe with ID and DII score only
DIIpre.ov3 <- DIIpre.ov2 %>%
  rownames_to_column('redcapid')
preDII1 <- data.frame(DIIpre.ov3$redcapid, DIIpre.ov3$DII)
preDII1 <- dplyr::rename(preDII1, "DII" = DIIpre.ov3.DII,
                "redcapid" = DIIpre.ov3.redcapid)


DIIpost.ov3 <- DIIpost.ov2 %>%
  rownames_to_column('redcapid')
postDII1 <- data.frame(DIIpost.ov3$redcapid, DIIpost.ov3$DII)
postDII1 <- dplyr::rename(postDII1, "DII" = DIIpost.ov3.DII,
                "redcapid" = DIIpost.ov3.redcapid)


#Calculate tertiles of DII
preDII2 <- preDII1 %>%
  dplyr::mutate(tertiles = ntile(DII, 3)) %>%
  dplyr::mutate(tertiles = if_else(tertiles == 1, 'Tertile 1', if_else(tertiles == 2, 'Tertile 2', 'Tertile 3'))) %>%
  dplyr::arrange(DII)


postDII2 <- postDII1 %>%
  dplyr::mutate(tertiles = ntile(DII, 3)) %>%
  dplyr::mutate(tertiles = if_else(tertiles == 1, 'Tertile 1', if_else(tertiles == 2, 'Tertile 2', 'Tertile 3'))) %>%
  dplyr::arrange(DII)

#dplyr::rename to merge dataframes
preDII3 <- dplyr::rename(preDII2, "pre.DII" = DII,
                            "pre.DII tertiles" = tertiles)

postDII3 <- dplyr::rename(postDII2, "post.DII" = DII,
                              "post.DII tertiles" = tertiles)

#merge pre and post partum DII scores

ppDII <- merge(preDII3, postDII3)
rownames(ppDII) <- ppDII[,1]
ppDII[,1] <- NULL

ppDII$change.DII <- ppDII$post.DII - ppDII$pre.DII

ppDII

```
`r table_nums("Vioscreen_DII_pre_post", display = "full")` 



## Basic Nutrient Table for pre-partum Vioscreen participants  
Snapshot of daily nutrient intake for Vioscreen population, pre-partum. 
Include calories, %carbs, %protein, %total fat, %sat fat, %monounsat fat, %polyunsat fat, %alcohol, fiber, cholesterol, Vitamin A (RE), Folic acid, Vitamin C, Vitamin D, VItamin E, Calcium, Iron, Potassium, Sodium
```{r preVioscreen-Nutrient-Table}
#Step 1: Select desired nutrient from DHQII raw data (use variable from above)####################
vNutrTD <- Vio %>% 
  select(BCODEID, STARTED, FINISHED, calories, carbo, protein, fat, sfatot, 
         mfatot, pfatot, alcohol, fiber, cholest, vita_rae, totfolat, vitc, 
         vitd, alphtoco, calcium, iron, potass, sodium)

#Remove test run rows
vNutrTD2 <- vNutrTD[-c(39:48), ]

#dplyr::filter original df to only contain pre-partum data and remove dates
vNutrTD3 <- vNutrTD2[-c(35, 30, 27, 26, 23), -c(2,3)]

#Make %energy columns for carbs, protein, total fat, sat fat, monounsat fat, polyunsat fat, and alcohol
vNutrTD3$pCarbs <- vNutrTD3$carbo*4/vNutrTD3$calories*100
vNutrTD3$pProtein <- vNutrTD3$protein*4/vNutrTD3$calories*100
vNutrTD3$pFat <- vNutrTD3$fat*9/vNutrTD3$calories*100
vNutrTD3$pSatFat <- vNutrTD3$sfatot*9/vNutrTD3$calories*100
vNutrTD3$pMonoFat <- vNutrTD3$mfatot*9/vNutrTD3$calories*100
vNutrTD3$pPolyFat <- vNutrTD3$pfatot*9/vNutrTD3$calories*100
vNutrTD3$pAlco <- vNutrTD3$alcohol*7/vNutrTD3$calories*100

#Reorder the table, keep only final variable columns
vNutrTD4 <- vNutrTD3[, c(1, 2, 21, 22, 23, 24, 25, 26, 27,  
                         10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20)]

#Energy correct discrete values
vNutrTD4b <- vNutrTD4[, 10:20]/vNutrTD4$calories*1000
#replace the original dataframe values with these corrected values
vNutrTD4[,10:20] <- vNutrTD4b

#make BCODEID into recapid

vNutrTD5 <- vNutrTD4 %>% dplyr::rename("redcapid" = BCODEID)

#Step 2: Merge with Demographic data###################################
#dplyr::filter nutrient table df to only have redcapids for final demographic dataframe (dplyr::filtered for DII)
vNutrTD6 <- vNutrTD5 %>%
  dplyr::filter(redcapid %in% vRCDemof3$redcapid)

#merge dataframes
vDemo_NutrT <- merge(vRCDemof3, vNutrTD6)
vDemo_NutrT2 <- vDemo_NutrT %>% remove_rownames %>% column_to_rownames(var="redcapid")

#remove the unwanted demo columns
names(vDemo_NutrT2) <- str_replace_all(names(vDemo_NutrT2),  c(" " = "."))

vDemo_NutrT3 <- subset(vDemo_NutrT2, select= -c(Age, Ethnicity, Relationship.Status, 
                                                Health.Insurance, Education, Employment, Income))

#dplyr::rename the variables
vDemo_NutrT4 <- dplyr::rename(vDemo_NutrT3,
                      "Energy (kcal)" = calories,
                      "% Carbohydrates" = pCarbs,
                      "% Protein" = pProtein,
                      "% Total Fat" = pFat,
                      "% Saturated Fat" = pSatFat,
                      "% Monounsaturated Fat" = pMonoFat,
                      "% Polyunsaturated Fat" = pPolyFat,
                      "% Alcohol" = pAlco,
                      "Fiber (g)" = fiber,
                      "Cholesterol (mg)" = cholest,
                      "Vitamin A (RE)" = vita_rae,
                      "Folic acid (μg)" = totfolat,
                      "Vitamin C (mg)" = vitc,
                      "Vitamin D (μg)" = vitd,
                      "Vitamin E (mg)" = alphtoco,
                      "Calcium (mg)" = calcium,
                      "Iron (mg)" = iron,
                      "Potassium (mg)" = potass,
                      "Sodium (mg)" = sodium)

#Step 3: Make the Table ###############################################
NutrientTableV <- tableby(Race ~ ., data = vDemo_NutrT4)
summary(NutrientTableV, title = "Race")

```
`r table_nums("Vio_nutr", display = "full")` 



## Basic Nutrient Table for post-partum Vioscreen participants  
Snapshot of daily nutrient intake for Vioscreen population, ppost-partum
Include calories, %carbs, %protein, %total fat, %sat fat, %monounsat fat, %polyunsat fat, %alcohol, fiber, cholesterol, Vitamin A (RE), Folic acid, Vitamin C, Vitamin D, VItamin E, Calcium, Iron, Potassium, Sodium
```{r postVioscreen-Nutrient-Table}
#Step 1: dplyr::filter variable from prepartum table to only be post partum (use variable from above)####################

#dplyr::filter original df to only contain pre-partum data and remove dates
vNutrTD3pp <- vNutrTD2[c(35, 30, 27, 26, 23), -c(2,3)]

#Make %energy columns for carbs, protein, total fat, sat fat, monounsat fat, polyunsat fat, and alcohol
vNutrTD3pp$pCarbs <- vNutrTD3pp$carbo*4/vNutrTD3pp$calories*100
vNutrTD3pp$pProtein <- vNutrTD3pp$protein*4/vNutrTD3pp$calories*100
vNutrTD3pp$pFat <- vNutrTD3pp$fat*9/vNutrTD3pp$calories*100
vNutrTD3pp$pSatFat <- vNutrTD3pp$sfatot*9/vNutrTD3pp$calories*100
vNutrTD3pp$pMonoFat <- vNutrTD3pp$mfatot*9/vNutrTD3pp$calories*100
vNutrTD3pp$pPolyFat <- vNutrTD3pp$pfatot*9/vNutrTD3pp$calories*100
vNutrTD3pp$pAlco <- vNutrTD3pp$alcohol*7/vNutrTD3pp$calories*100

#Reorder the table, keep only final variable columns
vNutrTD4pp <- vNutrTD3pp[, c(1, 2, 21, 22, 23, 24, 25, 26, 27,  
                         10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20)]

#Energy correct discrete values
vNutrTD4bpp <- vNutrTD4pp[, 10:20]/vNutrTD4pp$calories*1000
#replace the original dataframe values with these corrected values
vNutrTD4pp[,10:20] <- vNutrTD4bpp

#make BCODEID into recapid

vNutrTD5pp <- vNutrTD4pp %>% dplyr::rename("redcapid" = BCODEID)

#Step 2: Merge with Demographic data###################################
#dplyr::filter nutrient table df to only have redcapids for final demographic dataframe (dplyr::filtered for DII)
vNutrTD6pp <- vNutrTD5pp %>%
  dplyr::filter(redcapid %in% vRCDemof3$redcapid)

#merge dataframes
vDemo_NutrTpp <- merge(vRCDemof3, vNutrTD6pp)
vDemo_NutrT2pp <- vDemo_NutrTpp %>% remove_rownames %>% column_to_rownames(var="redcapid")

#remove the unwanted demo columns
names(vDemo_NutrT2pp) <- str_replace_all(names(vDemo_NutrT2pp),  c(" " = "."))

vDemo_NutrT3pp <- subset(vDemo_NutrT2pp, select= -c(Age, Ethnicity, Relationship.Status, 
                                                Health.Insurance, Education, Employment, Income))

#dplyr::rename the variables
vDemo_NutrT4pp <- dplyr::rename(vDemo_NutrT3pp,
                      "Energy (kcal)" = calories,
                      "% Carbohydrates" = pCarbs,
                      "% Protein" = pProtein,
                      "% Total Fat" = pFat,
                      "% Saturated Fat" = pSatFat,
                      "% Monounsaturated Fat" = pMonoFat,
                      "% Polyunsaturated Fat" = pPolyFat,
                      "% Alcohol" = pAlco,
                      "Fiber (g)" = fiber,
                      "Cholesterol (mg)" = cholest,
                      "Vitamin A (RE)" = vita_rae,
                      "Folic acid (μg)" = totfolat,
                      "Vitamin C (mg)" = vitc,
                      "Vitamin D (μg)" = vitd,
                      "Vitamin E (mg)" = alphtoco,
                      "Calcium (mg)" = calcium,
                      "Iron (mg)" = iron,
                      "Potassium (mg)" = potass,
                      "Sodium (mg)" = sodium)


#Step 3: Make the Table ###############################################
NutrientTableVpp <- tableby(Race ~ ., data = vDemo_NutrT4pp)
summary(NutrientTableVpp, title = "Race")

```
`r table_nums("Vio_nutr_post", display = "full")` 


## Healthy Eating Index (HEI) from Vioscreen {.tabset}  

### HEI Data combined with Demographics/DII  

```{r Vioscreen-HEI}
#dplyr::filter HEI data from raw vioscreen file
Vio_HEI <- Vio %>%
  select(BCODEID, STARTED, FINISHED, HEI2015Score, HEI2015_Whole_Fruit, HEI2015_Veg, 
         HEI2015_Greens_Beans, HEI2015_Whole_Grains, HEI2015_Dairy, HEI2015_Protein_Foods,
         HEI2015_SeaFoods_PlantProteins, HEI2015_Fatty_Acids, HEI2015_Refined_Grains, 
         HEI2015_Sodium, HEI2015_Saturated_Fat, HEI2015_Added_Sugars)

#Remove the practice redcapids
Vio_HEI2 <- Vio_HEI[-c(39:48), ]

#Make a Pre/Post-partum Vioscreen data into a seperate dataframe
Vio_pre_post_HEI <- Vio_HEI2[c(34, 35, 30, 31, 27,28, 25, 26, 24, 23),]


#dplyr::filter original df to only contain pre-partum data and remove dates
Vio_HEI3 <- Vio_HEI2[-c(35, 30, 27, 26, 23), -c(2,3)]

Vio_HEI4 <- dplyr::rename(Vio_HEI3, "redcapid" = BCODEID)

#dplyr::filter to just have redcapid and HEI2015 score 
Vio_HEI5 <- select(Vio_HEI4, redcapid, HEI2015Score)


#Merge with DII & Demographics
V_Demo_DII_HEI <- merge(vDemo_DII, Vio_HEI5)

#change redcapid to row names
V_Demo_DII_HEI2 <- V_Demo_DII_HEI %>% remove_rownames %>% column_to_rownames(var="redcapid")
V_Demo_DII_HEI3 <- V_Demo_DII_HEI2[, c(11,13,1,2,3,4,5,6,7,8,9,10,12)]

#make the table
VDDHtable <- tableby(tertiles ~ ., data = V_Demo_DII_HEI3)
summary(VDDHtable, title = "DII Tertile")

```
`r table_nums("Vioscreen_DII_Demo_HEI_Table", display = "full")` 


### HEI Changes Across Pregnancy  
Compare pre-partum and post-partum HEI2015 scores calculated from Vioscreen. 
```{r HEI-across_pregnancy}

#Seperate out Pre and Post Partum nutrient tables
V_HEI_pre <- Vio_pre_post_HEI[c(1,4,6,8,9), -c(2,3)]

V_HEI_post <- Vio_pre_post_HEI[c(2,3,5,7,10), -c(2,3)]

#Keep only HEI and redcapid
V_HEI_pre2 <- dplyr::rename(V_HEI_pre, "redcapid" = BCODEID, 
                     "pre.HEI" = HEI2015Score)
V_HEI_pre3 <- V_HEI_pre2[,c(1,2)]

V_HEI_post2 <- dplyr::rename(V_HEI_post, "redcapid" = BCODEID, 
                      "post.HEI" = HEI2015Score)
V_HEI_post3 <- V_HEI_post2[,c(1,2)]

#Merge dataframes
Vio_pre_post_HEI2 <- merge(V_HEI_pre3, V_HEI_post3)
rownames(Vio_pre_post_HEI2) <- Vio_pre_post_HEI2[,1]
Vio_pre_post_HEI2[,1] <- NULL

Vio_pre_post_HEI2$change.HEI <- Vio_pre_post_HEI2$post.HEI - Vio_pre_post_HEI2$pre.HEI

Vio_pre_post_HEI2
```
`r table_nums("vHEI_pre_post", display = "full")` 


### HEI change as a predictor for DII change  
HEI changes between across pregnancy as a predictor for change in DII score between pre and post-partum surveys.

```{r HEI-DII-PP-change}
HEI_DII_change <- merge(Vio_pre_post_HEI2, ppDII, by = 0, all = TRUE)
rownames(HEI_DII_change) <- HEI_DII_change[,1]
HEI_DII_change[,1] <- NULL

HEI_DII_change_plot <- ggscatter(HEI_DII_change, x = "change.HEI", y = "change.DII",
          add = "reg.line", conf.int = TRUE,
          cor.coef = TRUE, cor.method = "pearson",
          color = "steelblue", fill = "lightblue",
          xlab = "Change in HEI2015 Score", ylab = "Change in DII score")
HEI_DII_change_plot

```



# Combined DHQII & Vioscreen Data {.tabset}
*** 

## Combine Demographics, DII, HEI  
After data from the two different food frequency was standarized to DII and HEI parameters, we can now combine them into one dataframe to increase power of analysis. Additionally, dates for when teh surveys were conducted were included to match to trimester visit
```{r Combined-DATA, warning=FALSE}
#Step 1: Merge DII dataframes from DHQII and Vioscreen calculations #####################################
DIIcomb <- merge(Demo_DII_HEI, V_Demo_DII_HEI, all = TRUE)

#Step 2: Add in dates ###################################################################################

#DHQII survey dates
DHQII_Dates4$Survey_Date <- format(as.Date(DHQII_Dates4$Survey_Date),'%m/%d/%Y')
#Reformat the dates
DHQII_Dates4$Survey_Date <- str_replace_all(DHQII_Dates4$Survey_Date, 
                                            c("2017"= "17", "2018"= "18", "2019"= "19", "2020"= "20",
                                              "01" = "1", "02" = "2", "31" = "3", "04" = "4", "05" = "5",
                                              "06" = "6", "07" = "7", "08" = "8", "09" = "9"))


#Voioscreen survey dates
Vioscreen_Dates1$Survey_Date <- str_replace_all(Vioscreen_Dates1$Survey_Date, 
                                            c("2017"= "17", "2018"= "18", "2019"= "19", "2020"= "20",
                                              "01" = "1", "02" = "2", "31" = "3", "04" = "4", "05" = "5",
                                              "06" = "6", "07" = "7", "08" = "8", "09" = "9"))

Diet_Dates <- merge(DHQII_Dates4, Vioscreen_Dates1, all = TRUE)

#Step 3: Combine with all demographics data for future use ##############################################
DIIcomb_dates <- merge(DIIcomb, Diet_Dates, all = TRUE)

#Step 4: Reformat and make table #########################################################################
DIIcomb1 <- DIIcomb %>% remove_rownames %>% column_to_rownames(var="redcapid")
DIIcomb2 <- DIIcomb1[, c(9, 13, 1, 2, 3, 4, 5, 6, 7, 8, 10, 11, 12)]


#Step 5: Recalculate the Tertiles together
##########################################################################################################
DIIcomb3 <- DIIcomb2 %>%
  dplyr::mutate(tertiles = ntile(DII, 3)) %>%
  dplyr::mutate(tertiles = if_else(tertiles == 1, 'Tertile 1', 
                           if_else(tertiles == 2, 'Tertile 2', 
                                           'Tertile 3'))) %>%
  dplyr::arrange("DII")


#Make the combined table
DemoComb <- tableby(tertiles ~., data = DIIcomb3)
summary(DemoComb, title = "DII Tertile")


```
`r table_nums("Combined_DII_Demo_HEI_Table", display = "full")` 





## Variables effect on Diet Scores 
Add in exercise, cigarettes, alcohol, fermented food, sleep bowel quality, gestational weight, CBC data. Did not examine the change before and after preg (too little data) for smoking or alcohol and not for bowel movements either since I dont have microbiome data from before pregnancy   
__Key__  
Smoking & Alcohol key: Daily, Regularly (3-5 times/week), Occasionally (1-2 times/week), Rarely (few times/month), Never, I stopped when I realized I was pregnant    

Exercise: Daily |Regularly (3-5 times/week) | Occasionally (1-2 times/week) | Rarely (few times/month) | Never    

Bowel Movements: Less than one per day | 2, One per day | 3, Two per day | 4, Three per day | 5, Four per day | 6, Five or more per day | 7, It varies  

Bowel Quality: Solid and easy to pass |  Small hard lumps and difficult to pass (constipation) | Loose and watery (diarrhea) | Not sure | Other  

__Fermenters Key__

Fish sauce (1 serving = 1 Tbsp)  
Kefir (1 serving = 8 fluid ounces/1 cup)  
Kimchi (Korean fermented cabbage, 1 serving = 2 Tbsp)  
Kombucha  (1 serving = 8 fluid ounces/1 cup)  
Miso (Japanese soup, 1 serving = 1 cup; paste, 1 serving = 1 Tbsp)  
Pickles (1 serving = 1/2 cup)  
Pickled vegetables (not pickles; 1 serving = 1/2 cup)  
Tempeh (Indonesian fermented soy beans,  1 serving = 3 ounces)  
Sauerkraut (1 serving = 1/2 cup)  
Soy sauce (1 serving = 1 Tbsp)  
Yogurt (including Activia and soy yogurt) (1 serving = 1/2 cup)  

```{r Variables-to-examine}
#dplyr::filter these moms for the ones who also have DII diet data & from the first trimester visit (V0/V1) ######################################
# Redcap data csv
RedcapDf.c <- RedcapD %>%
  dplyr::filter(redcapid %in% DIIcomb$redcapid)


#Call Variables ####################################################################################

RedcapDf.c2 <- RedcapDf.c %>%
  select(redcapid, visit_visittype, visit_visitdate,  mr_v0_ega_weeks, mr_v1_ega_weeks, 
         mr_v2_ega_weeks,  mr_v3_ega_weeks, mr_v4_age_delivery, pi_age, pmq_cigarettes, 
         pmq_alcohol, pmq_averagesleep_bfrprg, pmq_averagesleep_now, pmq_excercise,
         pmq_bowelmovements_now, pmq_bowelquality_now, pmq_bowelquality_other_now, 
         mr_v1_gravida_previous, mr_v1_paraterm_previous, mr_v1_parapreterm_previous, 
         mr_v1_paraabortion_previous, mr_v1_wbc, mr_v1_rbc, 
         mr_v1_hbg, mr_v1_hct, mr_v1_mcv, mr_v1_mch, mr_v1_mhch, mr_v1_rdw, mr_v1_plt,
         mr_v1_mpv, mr_v1_hgb_a2, mr_v1_hgb_a, 
         mr_v1_hgb_f, mr_v1_hgb_s, mr_v1_hgb_fract_interpp, mr_v1_neut, mr_v1_lymph, 
         mr_v1_monos, mr_v1_eos, mr_v1_baso, mr_v1_abs_neut, mr_v1_abs_lymph, 
         mr_v1_abs_mono, 
         mr_v1_abs_eos, mr_v1_abs_baso)


#Reformat the raw data ############################################################################

#Remove rows with NA for the visit type column - redcap blanks
RedcapDf.c3 <- RedcapDf.c2[!is.na(RedcapDf.c2$visit_visittype), ]


#Gravida Para: Reformat to fit GPA formatting
RedcapDf.c3$mr_v1_gravida_previous <- sub("^", "G", RedcapDf.c3$mr_v1_gravida_previous)

RedcapDf.c3$mr_v1_para <- RedcapDf.c3$mr_v1_paraterm_previous + RedcapDf.c3$mr_v1_parapreterm_previous
RedcapDf.c3$mr_v1_para <- sub("^", "P", RedcapDf.c3$mr_v1_para)
RedcapDf.c3b <- subset(RedcapDf.c3, select=c(1:18,47,19:46)) #Re-ordering the rows to merge them
RedcapDf.c3c <-RedcapDf.c3b[,-c(20, 21)]

RedcapDf.c3c$mr_v1_paraabortion_previous <- sub("^", "A", RedcapDf.c3c$mr_v1_paraabortion_previous)

#Mass Reformatting
RedcapDf.c4 <- RedcapDf.c3c %>%
   dplyr::mutate(visit_visittype = case_when(
                     visit_visittype == 1 ~ "V0",
                     visit_visittype == 2 ~ "V1",
                     visit_visittype == 3 ~ "V2",
                     visit_visittype == 4 ~ "V3",
                     visit_visittype == 5 ~ "V4")) %>%
  dplyr::rename(Visit = visit_visittype) %>%
  dplyr::rename(Visit_Date = visit_visitdate) %>%
  unite("Gestational_age", mr_v0_ega_weeks:mr_v1_ega_weeks:mr_v2_ega_weeks:mr_v3_ega_weeks:mr_v4_age_delivery, 
        na.rm = TRUE, remove = TRUE, sep = "") %>%
  dplyr::rename(Age = pi_age) %>%
  dplyr::mutate(pmq_cigarettes = case_when(
                      pmq_cigarettes == 1 ~ "Daily",
                      pmq_cigarettes == 2 ~ "Regularly",
                      pmq_cigarettes == 3 ~ "Occasionally",
                      pmq_cigarettes == 4 ~ "Rarely",
                      pmq_cigarettes == 5 ~ "Never",
                      pmq_cigarettes == 6 ~ "Stopped_w_Preg")) %>%
  dplyr::rename(Smoking = pmq_cigarettes) %>%
   dplyr::mutate(pmq_alcohol = case_when(
                      pmq_alcohol == 1 ~ "Daily",
                      pmq_alcohol == 2 ~ "Regularly",
                      pmq_alcohol == 3 ~ "Occasionally",
                      pmq_alcohol == 4 ~ "Rarely",
                      pmq_alcohol == 5 ~ "Never",
                      pmq_alcohol == 6 ~ "Stopped_w_Preg")) %>%
  dplyr::rename(Alcohol = pmq_alcohol) %>%
  dplyr::mutate(pmq_averagesleep_bfrprg = case_when(
                      pmq_averagesleep_bfrprg == 1 ~ "<5 hr",
                      pmq_averagesleep_bfrprg == 2 ~ "5-7 hr",
                      pmq_averagesleep_bfrprg == 3 ~ "5-7 hr",
                      pmq_averagesleep_bfrprg == 4 ~ "7+ hr",
                      pmq_averagesleep_bfrprg == 5 ~ "7+ hr")) %>%
  dplyr::rename(Before_preg_Sleep = pmq_averagesleep_bfrprg) %>%
  dplyr::mutate(pmq_averagesleep_now = case_when(
                      pmq_averagesleep_now == 1 ~ "<5 hr",
                      pmq_averagesleep_now == 2 ~ "5-7 hr",
                      pmq_averagesleep_now == 3 ~ "5-7 hr",
                      pmq_averagesleep_now == 4 ~ "7+ hr",
                      pmq_averagesleep_now == 5 ~ "7+ hr")) %>%
  dplyr::rename(Sleep = pmq_averagesleep_now) %>%
  dplyr::mutate(pmq_excercise = case_when(
                      pmq_excercise == 1 ~ "Regularly",
                      pmq_excercise == 2 ~ "Regularly",
                      pmq_excercise == 3 ~ "Occasionally",
                      pmq_excercise == 4 ~ "Rarely/Never",
                      pmq_excercise == 5 ~ "Rarely/Never")) %>%
  dplyr::rename(Exercise = pmq_excercise) %>%
  dplyr::mutate(pmq_bowelmovements_now = case_when(
                      pmq_bowelmovements_now == 1 ~ "<1",
                      pmq_bowelmovements_now == 2 ~ "1-3",
                      pmq_bowelmovements_now == 3 ~ "1-3",
                      pmq_bowelmovements_now == 4 ~ "1-3",
                      pmq_bowelmovements_now == 5 ~ "4+",
                      pmq_bowelmovements_now == 6 ~ "4+",
                      pmq_bowelmovements_now == 7 ~ "Varies")) %>%
  dplyr::rename(Bowel_Movements = pmq_bowelmovements_now) %>%
  dplyr::mutate(pmq_bowelquality_now = case_when(
                      pmq_bowelquality_now == 1 ~ "Normal Solid",
                      pmq_bowelquality_now == 2 ~ "Constipated",
                      pmq_bowelquality_now == 3 ~ "Diarrhea",
                      pmq_bowelquality_now == 4 ~ "Unsure",
                      pmq_bowelquality_now == 5 ~ "Other")) %>%
  dplyr::rename(Bowel_Quality = pmq_bowelquality_now) %>%
  dplyr::rename(Bowel_Quality_Other = pmq_bowelquality_other_now) %>%
  unite("Gravida_Para", mr_v1_gravida_previous:mr_v1_para:mr_v1_paraabortion_previous, 
       na.rm = TRUE, remove = TRUE, sep = "") %>%
  dplyr::rename(WBC = mr_v1_wbc) %>%
  dplyr::rename(RBC = mr_v1_rbc) %>%
  dplyr::rename(HGB = mr_v1_hbg) %>%
  dplyr::rename(HCT = mr_v1_hct) %>%
  dplyr::rename(MCV = mr_v1_mcv) %>%
  dplyr::rename(MCH = mr_v1_mch) %>%
  dplyr::rename(MHCH = mr_v1_mhch) %>%
  dplyr::rename(RDW = mr_v1_rdw) %>%
  dplyr::rename(PLT = mr_v1_plt) %>%
  dplyr::rename(MPV = mr_v1_mpv) %>%
  dplyr::rename(HGB_A2 = mr_v1_hgb_a2) %>%
  dplyr::rename(HGB_A = mr_v1_hgb_a) %>%
  dplyr::rename(HGB_F = mr_v1_hgb_f) %>%
  dplyr::rename(HGB_S = mr_v1_hgb_s) %>%
  dplyr::rename(HGB_FRACT_INTERP = mr_v1_hgb_fract_interpp) %>%
  dplyr::rename(pNEUTROPHIL = mr_v1_neut) %>%
  dplyr::rename(pLYMPHOCYTE = mr_v1_lymph) %>%
  dplyr::rename(pMONOCYTE = mr_v1_monos) %>%
  dplyr::rename(pEOSINOPHIL = mr_v1_eos) %>%
  dplyr::rename(pBASOPHIL = mr_v1_baso) %>%
  dplyr::rename(absNEUTROPHIL = mr_v1_abs_neut) %>%
  dplyr::rename(absLYMPHOCYTE = mr_v1_abs_lymph) %>%
  dplyr::rename(absMONOCYTE = mr_v1_abs_mono) %>%
  dplyr::rename(absEOSINOPHIL = mr_v1_abs_eos) %>%
  dplyr::rename(absBASOPHIL = mr_v1_abs_baso)


# Fermenters data #################################################################

#Read in CSV 
Fermenters <- read_csv(here::here("Data", "Diet_Data", "PMHCRRMicrobiomeStar-MICROBIOME_DATA_2021-09-20_1257.csv"))

#dplyr::filter by redcapid 
Fermenters.1 <- Fermenters %>%
  dplyr::filter(redcapid %in% DIIcomb$redcapid)

#Select desired columns
Fermenters.2 <- Fermenters.1 %>% 
              select(redcapid, redcap_event_name, epm_fishsauce, epm_kefir, epm_kimchi, epm_kombucha, 
                     epm_miso, epm_pickedveg, epm_pickles, epm_tempeh, epm_sauerkraut, epm_sauerkraut,
                     epm_soysauce, epm_yogurt)

Fermenters.3 <- Fermenters.2 %>%
  dplyr::mutate(epm_fishsauce = case_when(epm_fishsauce == 1 ~ "Never",
                                   epm_fishsauce == 2 ~ "Rarely",
                                   epm_fishsauce == 3 ~ "Occastionally",
                                   epm_fishsauce == 4 ~ "Regularly",
                                   epm_fishsauce == 5 ~ "Daily")) %>%
  dplyr::rename("Fishsauce" = epm_fishsauce) %>%
  dplyr::mutate(epm_kefir = case_when(epm_kefir == 1 ~ "Never",
                                   epm_kefir == 2 ~ "Rarely",
                                   epm_kefir == 3 ~ "Occastionally",
                                   epm_kefir == 4 ~ "Regularly",
                                   epm_kefir == 5 ~ "Daily")) %>%
  dplyr::rename("Kefir" = epm_kefir) %>%
  dplyr::mutate(epm_kimchi = case_when(epm_kimchi == 1 ~ "Never",
                                  epm_kimchi == 2 ~ "Rarely",
                                   epm_kimchi == 3 ~ "Occastionally",
                                   epm_kimchi == 4 ~ "Regularly",
                                   epm_kimchi == 5 ~ "Daily")) %>%
  dplyr::rename("Kimchi" = epm_kimchi) %>%
  dplyr::mutate(epm_kombucha = case_when(epm_kombucha == 1 ~ "Never",
                                  epm_kombucha == 2 ~ "Rarely",
                                  epm_kombucha == 3 ~ "Occastionally",
                                  epm_kombucha == 4 ~ "Regularly",
                                  epm_kombucha == 5 ~ "Daily")) %>%
  dplyr::rename("Kombucha" = epm_kombucha) %>%
  dplyr::mutate(epm_miso = case_when(epm_miso  == 1 ~ "Never",
                                  epm_miso  == 2 ~ "Rarely",
                                  epm_miso  == 3 ~ "Occastionally",
                                  epm_miso  == 4 ~ "Regularly",
                                  epm_miso  == 5 ~ "Daily")) %>%
  dplyr::rename("Miso" = epm_miso) %>%
  dplyr::mutate(epm_pickedveg = case_when(epm_pickedveg  == 1 ~ "Never",
                                  epm_pickedveg  == 2 ~ "Rarely",
                                  epm_pickedveg  == 3 ~ "Occastionally",
                                  epm_pickedveg  == 4 ~ "Regularly",
                                  epm_pickedveg  == 5 ~ "Daily")) %>%
  dplyr::rename("Pickled_Veggies" = epm_pickedveg) %>%
  dplyr::mutate(epm_pickles = case_when(epm_pickles  == 1 ~ "Never",
                                  epm_pickles  == 2 ~ "Rarely",
                                  epm_pickles  == 3 ~ "Occastionally",
                                  epm_pickles == 4 ~ "Regularly",
                                  epm_pickles  == 5 ~ "Daily")) %>%
  dplyr::rename("Pickles" = epm_pickles) %>%
  dplyr::mutate(epm_tempeh = case_when(epm_tempeh   == 1 ~ "Never",
                                  epm_tempeh   == 2 ~ "Rarely",
                                  epm_tempeh   == 3 ~ "Occastionally",
                                  epm_tempeh  == 4 ~ "Regularly",
                                  epm_tempeh   == 5 ~ "Daily")) %>%
  dplyr::rename("Tempeh" = epm_tempeh ) %>%
  dplyr::mutate(epm_sauerkraut = case_when(epm_sauerkraut  == 1 ~ "Never",
                                  epm_sauerkraut   == 2 ~ "Rarely",
                                  epm_sauerkraut   == 3 ~ "Occastionally",
                                  epm_sauerkraut  == 4 ~ "Regularly",
                                  epm_sauerkraut   == 5 ~ "Daily")) %>%
  dplyr::rename("Sauerkraut" = epm_sauerkraut) %>%
  dplyr::mutate(epm_soysauce = case_when(epm_soysauce  == 1 ~ "Never",
                                  epm_soysauce   == 2 ~ "Rarely",
                                  epm_soysauce   == 3 ~ "Occastionally",
                                  epm_soysauce  == 4 ~ "Regularly",
                                  epm_soysauce   == 5 ~ "Daily")) %>%
  dplyr::rename("Soysauce" = epm_soysauce)  %>%
  dplyr::mutate(epm_yogurt = case_when(epm_yogurt  == 1 ~ "Never",
                                  epm_yogurt   == 2 ~ "Rarely",
                                  epm_yogurt   == 3 ~ "Occastionally",
                                  epm_yogurt  == 4 ~ "Regularly",
                                  epm_yogurt   == 5 ~ "Daily")) %>%
  dplyr::rename("Yogurt" = epm_yogurt)

RedcapDf.c5 <- merge(RedcapDf.c4, Fermenters.3, all=TRUE)

# Add in Iron from Nutrient Tables ##########################################################


```




Pull all of the V0 & V1 data to be our standard for the diet. The V4 visits were used as the filter for postpartum
```{r Variable-by_visit}
#Dataframes ###############################################################################

#Diet Survey Visit data #########################
#pull only those redcapids
Diet.data <- RedcapDf.c4 %>% 
  dplyr::filter(redcapid %in% Diet_Dates$redcapid)

filterdates <- c("V0", "V1")
filterdates2 <- c("V4")

Diet.data.prepartum <- Diet.data %>%
  dplyr::filter(Visit %in% filterdates)

# pull data with date closest to survey date ####################################
# missing redcap data for 187, 208B, 229B, 230B, 398, 401
# Those with two survey dates - 360, 365, 378, 379 (should be post-partum)

Diet.data.postpartum <- Diet.data %>%
  dplyr::filter(Visit %in% filterdates2)

Diet.data.prepartum1 <- Diet.data.prepartum[-c(16,22,25,28,54,61),]


Diet.data.prepartum2 <- remove_rownames(Diet.data.prepartum1)
Diet.data.prepartum3 <- column_to_rownames(Diet.data.prepartum2, var = "redcapid")

#Merge with Diet data
Diet.data.prepartum4 <- merge(DIIcomb2, Diet.data.prepartum3, by = 0)
Diet.data.prepartum5 <- Diet.data.prepartum4 %>% dplyr::rename("redcapid" = Row.names) %>% 
                                                 dplyr::rename("Relationship_Status" = `Relationship Status`) %>%
                                                 dplyr::rename("Health_Insurance" = `Health Insurance`) %>%
                                                 dplyr::rename("Planned_Pregnancy" = `Planned Pregnancy`) %>%
                                                 dplyr::rename("Age" = Age.x)
Diet.data.prepartum6 <- column_to_rownames(Diet.data.prepartum5, var = "redcapid")
Diet.data.prepartum7 <- select(Diet.data.prepartum6, -"tertiles") #remove tertile column


# Add in fetal sex ###########################################################################
#dataframe with neonate info
neonate <- read.csv(here::here("Data","Random_Data", "CCTSCRDWRequestUICCI-Neonate_DATA_2022-02-16_1219.csv"))
neonate2 <- neonate %>% dplyr::rename(redcapid = record_id) %>%
    dplyr::mutate(mr_neo_neonate_sex = case_when(mr_neo_neonate_sex  == 1 ~ "F",
                                  mr_neo_neonate_sex  == 0 ~ "M")) %>%
    dplyr::rename(Fetal_sex = mr_neo_neonate_sex) %>%
    select(redcapid, Fetal_sex)
#Add to other data
Diet.data.prepartum8 <- rownames_to_column(Diet.data.prepartum6, "redcapid")
Diet.data.prepartum9 <- merge(Diet.data.prepartum8, neonate2, by = "redcapid")
Diet.data.prepartum9 
```




# Statistical analysis among Diet and various factors of interest

## Set up  
Separate the variables into categorical and continuous to analyze. Log correct DII scores to account for the variation in scores

```{r Summary-Stats}
#Step1: Separate into categorical and continuous data for the differential analysis #####################

#Categorical
Diet.cat <- subset(Diet.data.prepartum6, select = c("DII", "HEI2015Score", "Ethnicity", "Race", 
                                                    "Relationship_Status", "Health_Insurance", "Education", 
                                                    "Employment", "tertiles", "Income",
                                                    "Planned_Pregnancy", "Visit", "Smoking", "Alcohol",
                                                    "Before_preg_Sleep", "Sleep", "Exercise", 
                                                    "Bowel_Movements", "Bowel_Quality"))

Diet.cat$logDII <- log(Diet.cat[,1] +3.8) #log correct DII

#Continuous
Diet.cont <- subset(Diet.data.prepartum6, select = c("DII", "HEI2015Score", "Age", "BMI"))

Diet.cont$logDII <- log(Diet.cont[,1] +3.8) #log correct DII


#CBC Data
Diet.CBC <- subset(Diet.data.prepartum6, select = c("WBC", "RBC", "HGB", "HCT", "MCV", 
                                                   "MCH", "MHCH", "RDW", "PLT", "MPV", "HGB_A2", "HGB_A",
                                                     "HGB_F", "HGB_S", "HGB_FRACT_INTERP", "pNEUTROPHIL",
                                                     "pLYMPHOCYTE", "pMONOCYTE", "pEOSINOPHIL", "pBASOPHIL",
                                                     "absNEUTROPHIL","absLYMPHOCYTE", "absMONOCYTE",
                                                     "absEOSINOPHIL", "absBASOPHIL"))
Diet.CBC2 <- Diet.CBC %>% 
              transform(Diet.CBC, HGB = as.numeric(HGB),
                                   HCT = as.numeric(HCT),
                                   MCH = as.numeric(MCH),
                                   RDW = as.numeric(RDW),
                                   HGB_F = as.numeric(HGB_F),
                                   HGB_S = as.numeric(HGB_S),
                                   HGB_FRACT_INTERP = as.numeric(HGB_FRACT_INTERP),
                                   absNEUTROPHIL = as.numeric(absNEUTROPHIL))



```


# Transition to Microbiome Analysis 
***  
  
The following chunks are designed to consolidate info used in the microbiome analysis notebook (separate R notebook)


## List of redcapid's to be analyzed  
Create csv's written to desktop to use in the separate microbiome analysis notebook. Files saved to the Microbiome output folder of this R project

```{r ID-Lists}
#CSV  of IDs for pipeline analysis
M_redcapids <-  Diet.data.prepartum5%>% 
  select(redcapid, Visit)
write.csv(M_redcapids, here::here("Data", "Microbiome_Data", "Diet_redcapids.csv"))

#CSV with redcapid and diet parameters
Diet_results <- as.data.frame(DIIcomb[,c(1, 12, 14)])
write.csv(Diet_results, here::here("Output", "Diet_Output", "Diet_results.csv"))

#CSV with all demographic/diet data and add in EGA and Fetal sex
EGA <- Diet.data.prepartum9 %>% select("redcapid", "Gestational_age", "Fetal_sex")
DIIcomb4 <- rownames_to_column(DIIcomb3, "redcapid")
DIIcomb_EGA <- merge(DIIcomb4, EGA, by = "redcapid", all = TRUE)

write.csv(DIIcomb_EGA, here::here("Output", "Diet_Output", "Demo_Diet_results.csv"))

#pre-partum Diet participants by survey date
write.csv(Diet.data.prepartum, here::here("Data", "Microbiome_Data", "Prepartum_Diet_data.csv"))

#post-partum Diet participants by survey date
write.csv(Diet.data.postpartum, here::here("Data", "Microbiome_Data", "Postpartum_Diet_data.csv"))

# Table of all the food parameters used to calculate DII (n=27)
DHQQ_DII_data <- DHQQ_DII_data %>% rownames_to_column("redcapid")
Vio_f4 <- Vio_f4 %>% rownames_to_column("redcapid")
DII_parameters <- rbind(DHQQ_DII_data, Vio_f4)
write.csv(DII_parameters, here::here("Output", "Diet_Output", "DII_parameters_data.csv"))


```



```{r}
#DIIcomb_dates <- DIIcomb_dates %>% filter(redcapid %in% info$redcapid)
#Diet.data.prepartum9 <- Diet.data.prepartum9 %>% filter(redcapid %in% info$redcapid)
#datacheck <- merge(Diet.data.prepartum9, DIIcomb_dates, by = "redcapid")

#datacheck$Visit_Date <- as.Date(datacheck$Visit_Date, format = "%m/%d/%y")
#datacheck$Survey_Date <- as.Date(datacheck$Survey_Date, format = "%m/%d/%y")

#datacheck <- datacheck %>%
#  distinct(redcapid, .keep_all = TRUE)

# Calculate the absolute difference between Visit_date and Survey_date
#datacheck <- datacheck %>%
#  mutate(diff_dates = abs(Visit_Date - Survey_Date)/7)

# Calculate the mean and standard deviation of the absolute differences
#mean_diff <- mean(datacheck$diff_dates, na.rm = TRUE)
#sd_diff <- sd(datacheck$diff_dates, na.rm = TRUE)

# Print the results
#cat("Mean of absolute differences:", mean_diff, "\n")
#cat("Standard deviation of absolute differences:", sd_diff, "\n")


```




